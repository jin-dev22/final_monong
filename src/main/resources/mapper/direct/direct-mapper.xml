<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.monong.direct.model.dao.DirectDao">
<!-- 재경 시작 -->
<!-- 옵션 등록 -->
<update id="mergeOption">
  	merge into direct_product_option
    using dual
    on (d_option_no = #{dOptionNo})
        when matched then
            update set d_sale_status = #{dSaleStatus},
                            d_price = #{dPrice},
                            d_stock = #{dStock}
        when not matched then
            insert (d_option_no, d_product_no, d_option_name, d_sale_status, d_price, d_stock) values ('DO'||seq_d_option_no.nextval, #{dProductNo}, #{dOptionName}, #{dSaleStatus}, #{dPrice}, #{dStock})
  </update>
<!-- 재경 끝 -->
<!-- 민지 시작 -->
  <select id="selectOneDirectProductCollection" resultMap="directProductMap">
  	select
	    dp.*,
	    m.member_name,
	    dpo.*,
	    dpa.*,
	    to_number(substr(d_option_no, 3)) no
	from
	    direct_product dp
	    	left join member m
                on dp.member_id = m.member_id
	        left join direct_product_option dpo
	            on dp.d_product_no = dpo.d_product_no
	        left join direct_product_attachment dpa
	            on dp.d_product_no = dpa.d_product_no
	where
	    dp.d_product_no = #{dProductNo}
	order by
		d_sale_status desc, d_option_name, d_price, no, d_product_attach_no
  </select>
  
  <resultMap type="directProduct" id="directProductMap">
  	<id column="d_product_no" property="dProductNo"/>
  	<result column="member_id" property="memberId"/>
  	<result column="d_product_name" property="dProductName"/>
  	<result column="d_product_content" property="dProductContent"/>
  	<result column="d_product_created_at" property="dProductCreatedAt"/>
  	<result column="d_product_updated_at" property="dProductUpdatedAt"/>
  	<result column="d_default_price" property="dDefaultPrice"/>
  	<result column="d_delivery_fee" property="dDeliveryFee"/>
  	<association property="member" javaType="member">
  		<id column="member_id" property="memberId"/>
  		<result column="member_name" property="memberName"/>
  	</association>
  	<collection property="directProductOptions" ofType="DirectProductOption">
  		<id column="d_option_no" property="dOptionNo"/>
  		<result column="d_product_no" property="dProductNo"/>
  		<result column="d_option_name" property="dOptionName"/>
  		<result column="d_sale_status" property="dSaleStatus"/>
  		<result column="d_price" property="dPrice"/>
  		<result column="d_stock" property="dStock"/>
  	</collection>
  	<collection property="directProductAttachments" ofType="DirectProductAttachment">
  		<id column="d_product_attach_no" property="dProductAttachNo"/>
  		<result column="d_product_no" property="dProductNo"/>
  		<result column="d_product_original_filename" property="dProductOriginalFilename"/>
  		<result column="d_product_renamed_filename" property="dProductRenamedFilename"/>
  	</collection>
  </resultMap>
  
  <select id="selectOrderListByCartNo" resultMap="orderListMap">
  	select
	    c.*,
	    dpo.*,
	    dpa.*,
	    dp.d_product_no,
	    dp.d_product_name,
	    dp.d_default_price,
	    dp.d_delivery_fee,
	    dp.member_id seller
	from
	    cart c
	        left join direct_product_option dpo
	            on c.d_option_no = dpo.d_option_no
	        left join direct_product dp
	            on dpo.d_product_no = dp.d_product_no
	        left join direct_product_attachment dpa
        		on dp.d_product_no = dpa.d_product_no
	where
	    c.cart_no = #{cartNo}
	order by
		d_product_attach_no
  </select>
  
  <select id="selectCartListByMemberId" resultMap="cartListMap">
  	select
	    c.*,
	    dpo.*,
	    dpa.*,
	    dp.d_product_no,
	    dp.d_product_name,
	    dp.d_default_price,
	    dp.d_delivery_fee,
	    dp.member_id seller
	from
	    cart c 
	        left join direct_product_option dpo
	            on c.d_option_no = dpo.d_option_no
	        left join direct_product dp
	            on dpo.d_product_no = dp.d_product_no
	        left join direct_product_attachment dpa
	            on dp.d_product_no = dpa.d_product_no
	where
	    c.member_id = #{memberId}
	order by
	    cart_no, d_product_attach_no
  </select>
  
  <resultMap type="directProduct" id="orderListMap">
  	<id column="d_product_no" property="dProductNo"/>
  	<result column="d_product_name" property="dProductName"/>
  	<result column="d_default_price" property="dDefaultPrice"/>
  	<result column="d_delivery_fee" property="dDeliveryFee"/>
  	<result column="seller" property="memberId"/>
  	<association property="directProductOptions" javaType="DirectProductOption">
  		<id column="d_option_no" property="dOptionNo"/>
  		<result column="d_product_no" property="dProductNo"/>
  		<result column="d_option_name" property="dOptionName"/>
  		<result column="d_sale_status" property="dSaleStatus"/>
  		<result column="d_price" property="dPrice"/>
  		<result column="d_stock" property="dStock"/>
  	</association>
  	<association property="cart" javaType="CartEntity">
  		<id column="cart_no" property="cartNo"/>
  		<result column="d_option_no" property="dOptionNo"/>
  		<result column="member_id" property="memberId"/>
  		<result column="product_count" property="productCount"/>
  	</association>
  	<collection property="directProductAttachments" ofType="DirectProductAttachment">
  		<id column="d_product_attach_no" property="dProductAttachNo"/>
  		<result column="d_product_no" property="dProductNo"/>
  		<result column="d_product_original_filename" property="dProductOriginalFilename"/>
  		<result column="d_product_renamed_filename" property="dProductRenamedFilename"/>
  	</collection>
  </resultMap>
  
  <resultMap type="Cart" id="cartListMap">
  	<id column="cart_no" property="cartNo"/>
	<result column="d_option_no" property="dOptionNo"/>
	<result column="member_id" property="memberId"/>
	<result column="product_count" property="productCount"/>
  	<association property="directProductOption" javaType="DirectProductOption">
  		<id column="d_option_no" property="dOptionNo"/>
  		<result column="d_product_no" property="dProductNo"/>
  		<result column="d_option_name" property="dOptionName"/>
  		<result column="d_sale_status" property="dSaleStatus"/>
  		<result column="d_price" property="dPrice"/>
  		<result column="d_stock" property="dStock"/>
  	</association>
  	<association property="directProduct" javaType="DirectProductEntity">
  		<id column="d_product_no" property="dProductNo"/>
	  	<result column="d_product_name" property="dProductName"/>
	  	<result column="d_default_price" property="dDefaultPrice"/>
	  	<result column="d_delivery_fee" property="dDeliveryFee"/>
	  	<result column="seller" property="memberId"/>
  	</association>
  	<collection property="directProductAttachments" ofType="DirectProductAttachment">
  		<id column="d_product_attach_no" property="dProductAttachNo"/>
  		<result column="d_product_no" property="dProductNo"/>
  		<result column="d_product_original_filename" property="dProductOriginalFilename"/>
  		<result column="d_product_renamed_filename" property="dProductRenamedFilename"/>
  	</collection>
  </resultMap>
  
<!-- 민지 끝 -->

<!-- 수진 시작 -->
<select id="adminSelectProdList" resultMap="directProductListMap">
  	select * 
	from 
	    direct_product 
	    left join 
	    direct_product_option 
	        using(d_product_no)
	where 
	    d_product_no in(select 
	    					distinct d_product_no
                        from 
	                        direct_product 
	                        left join 
	                        direct_product_option 
	                        using(d_product_no)
                        where 
                        	d_sale_status = #{dSaleStatus})
   	order by d_product_created_at desc
  </select>
  <resultMap type="directProduct" id="directProductListMap">
  	<id column="d_product_no" property="dProductNo"/>
  	<result column="member_id" property="memberId"/>
  	<result column="d_product_name" property="dProductName"/>
	<result column="d_product_content" property="dProductContent"/>
  	<result column="d_product_created_at" property="dProductCreatedAt"/>
  	<result column="d_product_updated_at" property="dProductUpdatedAt"/>
  	<result column="d_default_price" property="dDefaultPrice"/>
  	<collection property="directProductOptions" ofType="DirectProductOption">
  		<id column="d_option_no" property="dOptionNo"/>
  		<result column="d_product_no" property="dProductNo"/>
  		<result column="d_option_name" property="dOptionName"/>
  		<result column="d_sale_status" property="dSaleStatus"/>
  		<result column="d_price" property="dPrice"/>
  		<result column="d_stock" property="dStock"/>
  	</collection>
  </resultMap>
  
  <update id="updateDirectProduct">
  	update direct_product
  	set d_product_content = #{dProductContent},
  		d_default_price = #{dDefaultPrice},
  		d_delivery_fee = #{dDeliveryFee},
  		d_product_updated_at = current_date 
  	where d_product_no = #{dProductNo}
  </update>
  
  <update id="mergeIntoDOption">
  	merge into direct_product_option
    using dual
    on (d_option_no = #{dOptionNo})
        when matched then
            update set d_sale_status = #{dSaleStatus},
                            d_price = #{dPrice},
                            d_stock = #{dStock}
        when not matched then
            insert (d_option_no, d_product_no, d_option_name, d_sale_status, d_price, d_stock) values ('DO'||seq_d_option_no.nextval, #{dProductNo}, #{dOptionName}, #{dSaleStatus}, #{dPrice}, #{dStock})
  </update>
<!-- 수진 끝 -->
</mapper>