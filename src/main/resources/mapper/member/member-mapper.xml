<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.monong.member.model.dao.MemberDao">
<!-- =============================================================수진 시작 -->
  <update id="insertEmailIdentify">
  	merge into member_email_identify
  		using dual 
  		on (member_email = #{memberEmail})
  		when matched then
  			update set
  				identify_key = #{identifyKey}
  		when not matched then
  			insert (member_email, identify_key)
  			values (#{memberEmail}, #{identifyKey})	
  </update>
  
  <select id="getTotalOrderCntByProdNo" resultType="_int">
  	select count(*)
	from 
		(select distinct d_order_no 
		 from member_direct_order 
		 where d_product_no = #{prodNo}
		 <if test="startDate != null and endDate != null">	
		 	and d_order_no in(
    		select d_order_no 
    		from direct_order 
    		where d_order_date between #{startDate} and #{endDate})
   		 </if>
		 )
  </select>
  
  <select id="getTotalProdCntBySeller" resultType="_int">
  	select count(*)
	from
	(select distinct d_product_no
	 from direct_product 
	        left join 
	        direct_product_option using(d_product_no) 
	where member_id = #{memberId} and d_sale_status = #{dSaleStatus})
  </select>
  
  <select id="selectOrderListByProdNo" resultMap="orderMap">
  	select ord.*, (select d_option_name from direct_product_option) d_option_name
	from
		(select * 
		 from direct_order do 
		 left join 
		 member_direct_order mdo using(d_order_no)
		 ) ord
	where d_product_no = #{prodNo}
        <if test="startDate != null and endDate != null">				
			and
	   		d_order_date between #{startDate} and #{endDate}
		</if>
	    
  </select>
  <resultMap type="map" id="orderMap">
  	<id column="d_order_no" property="dOrderNo"/>
  	<result column="member_id" property="customerId"/>
  	<result column="d_total_price" property="dTotalPrice"/>
  	<result column="d_dest_address" property="dDestAddress"/>
  	<result column="d_dest_address_ex" property="dDestAddressEx"/>
  	<result column="d_delivery_request" property="dDeliveryRequest"/>
  	<result column="d_recipient" property="dRecipient"/>
  	<result column="d_order_phone" property="dOrderPhone"/>
  	<result column="d_order_date" property="dOrderDate"/>
  	<result column="d_payments" property="dPayments"/>
  	<result column="d_order_status" property="dOrderStatus"/>
  	<collection property="dProdOptions" ofType="map">
  		<id column="d_option_no" property="dOptionNo"/>
  		<result column="d_option_count" property="dOptionCount"/>
  		<result column="d_option_name" property="dOptionName"/>
  	</collection>
  </resultMap>
  
  <select id="selectDirectListBySellerId" resultMap="directProductListMap">
  	select * 
	from 
	    direct_product 
	    left join 
	    direct_product_option 
	        using(d_product_no)
	where 
	    d_product_no in(select 
	    					distinct d_product_no
                        from 
	                        direct_product 
	                        left join 
	                        direct_product_option 
	                        using(d_product_no)
                        where 
                        	member_id = #{memberId} and d_sale_status = #{dSaleStatus})
  </select>
  <resultMap type="directProduct" id="directProductListMap">
  	<id column="d_product_no" property="dProductNo"/>
  	<result column="member_id" property="memberId"/>
  	<result column="d_product_name" property="dProductName"/>
	<!-- <result column="d_product_content" property=""/> -->
  	<result column="d_product_created_at" property="dProductCreatedAt"/>
  	<result column="d_product_updated_at" property="dProductUpdatedAt"/>
  	<result column="d_default_price" property="dDefaultPrice"/>
  	<collection property="directProductOptions" ofType="DirectProductOption">
  		<id column="d_option_no" property="dOptionNo"/>
  		<result column="d_product_no" property="dProductNo"/>
  		<result column="d_option_name" property="dOptionName"/>
  		<result column="d_sale_status" property="dSaleStatus"/>
  		<result column="d_price" property="dPrice"/>
  		<result column="d_stock" property="dStock"/>
  	</collection>
  </resultMap>
 
<!-- ==================================================수진 끝 -->
</mapper>